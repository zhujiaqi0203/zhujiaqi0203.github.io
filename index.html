<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>复古像素风贪吃蛇</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pixelRed: '#FF3B30',
                        pixelOrange: '#FF9500',
                        pixelYellow: '#FFCC00',
                        pixelGreen: '#34C759',
                        pixelBlue: '#007AFF',
                        pixelPurple: '#AF52DE',
                        pixelDark: '#1A1F36',
                        pixelDarker: '#121629'
                    },
                    fontFamily: {
                        pixel: ['"Press Start 2P"', 'monospace', 'system-ui']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .pixel-borders {
                box-shadow: 0 -4px 0 4px #3A3F5C,
                            4px 0 0 4px #3A3F5C,
                            0 4px 0 4px #3A3F5C,
                            -4px 0 0 4px #3A3F5C;
            }
            .pixel-borders-hover {
                transition: all 0.2s ease;
            }
            .pixel-borders-hover:hover {
                box-shadow: 0 -4px 0 4px #5A5F7C,
                            4px 0 0 4px #5A5F7C,
                            0 4px 0 4px #5A5F7C,
                            -4px 0 0 4px #5A5F7C,
                            0 0 10px 5px rgba(90, 95, 124, 0.3);
            }
            .pulse-animation {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            .score-popup {
                animation: pop 0.3s ease-out;
            }
            @keyframes pop {
                0% { transform: scale(1); }
                50% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
            .grid-pattern {
                background-image: linear-gradient(rgba(58, 63, 92, 0.1) 1px, transparent 1px),
                                linear-gradient(90deg, rgba(58, 63, 92, 0.1) 1px, transparent 1px);
                background-size: 30px 30px;
            }
            .half-tone-1 {
                background-image: radial-gradient(#fff 1px, transparent 1px);
                background-size: 10px 10px;
                background-position: 0 0;
            }
            .half-tone-2 {
                background-image: radial-gradient(#fff 1px, transparent 1px);
                background-size: 10px 10px;
                background-position: 5px 5px;
            }
            .half-tone-3 {
                background-image: radial-gradient(#fff 2px, transparent 1px);
                background-size: 15px 15px;
                background-position: 0 0;
            }
            .food-pulse {
                animation: foodPulse 1s infinite alternate;
            }
            @keyframes foodPulse {
                0% { transform: scale(1); opacity: 0.8; }
                100% { transform: scale(1.1); opacity: 1; }
            }
            .game-over {
                animation: gameOverFade 0.5s ease-in-out;
            }
            @keyframes gameOverFade {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .pixel-btn {
                transition: transform 0.1s ease;
            }
            .pixel-btn:active {
                transform: scale(0.9);
            }
            .pixel-btn-hover:hover {
                transform: scale(1.1);
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-pixelDark to-pixelDarker min-h-screen text-white overflow-hidden" ontouchmove="event.preventDefault()" style="touch-action: none;">
    <div class="container mx-auto px-2 py-4 flex flex-col h-screen max-w-4xl">
        <!-- 游戏标题 -->
        <header class="text-center mb-2">
            <h1 class="font-pixel text-[clamp(1rem,5vw,1.5rem)] text-pixelYellow pulse-animation">复古像素风贪吃蛇</h1>
        </header>

        <!-- 游戏区域 -->
        <main class="flex-grow flex flex-col items-center justify-center relative">
            <div id="scoreBoard" class="absolute top-0 right-2 bg-black/50 backdrop-blur-sm px-3 py-1 rounded-md font-pixel text-pixelGreen text-sm z-10">
                分数: <span id="score">0</span>
            </div>
            
            <div class="relative pixel-borders pixel-borders-hover bg-dark grid-pattern rounded-sm">
                <canvas id="gameCanvas" class="block"></canvas>
                
                <!-- 移动端控制按钮 -->
                <div id="mobileControls" class="fixed bottom-4 left-0 right-0 flex justify-center items-center gap-4 px-4 z-20">
                    <div class="grid grid-cols-3 gap-2 w-full max-w-xs">
                        <div class="col-start-2">
                            <button id="btnUp" class="pixel-btn pixel-btn-hover w-full aspect-square bg-pixelBlue/70 rounded-md flex items-center justify-center">
                                <i class="fa fa-chevron-up text-lg"></i>
                            </button>
                        </div>
                        <div class="col-start-1 row-start-2">
                            <button id="btnLeft" class="pixel-btn pixel-btn-hover w-full aspect-square bg-pixelBlue/70 rounded-md flex items-center justify-center">
                                <i class="fa fa-chevron-left text-lg"></i>
                            </button>
                        </div>
                        <div class="col-start-2 row-start-2">
                            <button id="btnDown" class="pixel-btn pixel-btn-hover w-full aspect-square bg-pixelBlue/70 rounded-md flex items-center justify-center">
                                <i class="fa fa-chevron-down text-lg"></i>
                            </button>
                        </div>
                        <div class="col-start-3 row-start-2">
                            <button id="btnRight" class="pixel-btn pixel-btn-hover w-full aspect-square bg-pixelBlue/70 rounded-md flex items-center justify-center">
                                <i class="fa fa-chevron-right text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 暂停按钮 -->
                <button id="pauseBtn" class="fixed top-4 left-2 bg-pixelPurple/70 pixel-btn pixel-btn-hover px-3 py-1 rounded-md font-pixel text-xs z-10">
                    <i class="fa fa-pause mr-1"></i>暂停
                </button>
            </div>
            
            <!-- 游戏结束遮罩 -->
            <div id="gameOverScreen" class="hidden absolute inset-0 bg-black/70 backdrop-blur-sm flex flex-col items-center justify-center game-over z-30">
                <h2 class="font-pixel text-[clamp(1.5rem,8vw,2.5rem)] mb-4 bg-clip-text text-transparent bg-gradient-to-r from-pixelRed to-pixelOrange">游戏结束</h2>
                <p class="font-pixel text-pixelYellow mb-6">最终得分: <span id="finalScore">0</span></p>
                <button id="restartBtn" class="font-pixel bg-pixelGreen hover:bg-pixelGreen/80 text-white px-6 py-3 rounded-md pixel-btn pixel-btn-hover">
                    重新开始
                </button>
            </div>
            
            <!-- 食物图片上传 -->
            <div class="mt-4 flex flex-wrap gap-2 justify-center items-center">
                <label for="foodImageUpload" class="font-pixel bg-pixelPurple/70 px-3 py-2 rounded-md text-sm cursor-pointer pixel-btn">
                    <i class="fa fa-upload mr-1"></i>选择图片
                </label>
                <input type="file" id="foodImageUpload" accept="image/*" class="hidden">
                <button id="resetFoodBtn" class="font-pixel bg-pixelOrange/70 px-3 py-2 rounded-md text-sm pixel-btn">
                    <i class="fa fa-refresh mr-1"></i>恢复默认
                </button>
            </div>
        </main>

        <!-- 操作说明 -->
        <footer class="mt-4 mb-20 md:mb-4 text-center">
            <p class="font-pixel text-xs text-gray-400">使用方向键控制 | 空格键暂停</p>
        </footer>
    </div>

    <script>
        // 禁用页面滑动
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        // 游戏常量和变量
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const finalScoreElement = document.getElementById('finalScore');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const restartBtn = document.getElementById('restartBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const foodImageUpload = document.getElementById('foodImageUpload');
        const resetFoodBtn = document.getElementById('resetFoodBtn');
        
        // 移动控制按钮
        const btnUp = document.getElementById('btnUp');
        const btnDown = document.getElementById('btnDown');
        const btnLeft = document.getElementById('btnLeft');
        const btnRight = document.getElementById('btnRight');

        // 游戏设置
        let gridSize = 20;
        let snake = [];
        let food = {};
        let direction = '';
        let nextDirection = '';
        let score = 0;
        let gameSpeed = 150;
        let gameLoop;
        let isPaused = false;
        let gameOver = false;
        let explosionEffects = [];
        
        // 蛇身颜色数组
        const snakeColors = [
            '#FF3B30', // 红
            '#FF9500', // 橙
            '#FFCC00', // 黄
            '#34C759', // 绿
            '#007AFF', // 蓝
            '#AF52DE'  // 紫
        ];
        
        // 半调图案类型
        const halfTonePatterns = ['half-tone-1', 'half-tone-2', 'half-tone-3'];
        
        // 食物图片
        let foodImage = new Image();
        foodImage.src = 'https://picsum.photos/seed/cherry/20/20'; // 默认樱桃图片
        let customFoodImage = null;

        // 设置Canvas尺寸
        function resizeCanvas() {
            // 确保canvas在不同屏幕尺寸下保持正方形
            const containerWidth = canvas.parentElement.clientWidth;
            const containerHeight = canvas.parentElement.clientHeight;
            const size = Math.min(containerWidth, containerHeight);
            
            // 调整尺寸为网格大小的倍数
            const adjustedSize = Math.floor(size / gridSize) * gridSize;
            
            canvas.width = adjustedSize;
            canvas.height = adjustedSize;
            
            // 如果游戏已经开始，重新绘制
            if (snake.length > 0) {
                draw();
            }
        }

        // 初始化游戏
        function initGame() {
            // 设置网格大小（根据屏幕尺寸调整）
            const screenSize = Math.min(window.innerWidth, window.innerHeight);
            gridSize = screenSize < 400 ? 15 : 20;
            
            // 重置蛇
            const center = Math.floor((canvas.width / gridSize) / 2);
            snake = [
                { x: center, y: center },
                { x: center - 1, y: center },
                { x: center - 2, y: center }
            ];
            
            // 初始方向
            direction = 'right';
            nextDirection = 'right';
            
            // 重置分数和速度
            score = 0;
            gameSpeed = 150;
            scoreElement.textContent = score;
            
            // 生成食物
            generateFood();
            
            // 隐藏游戏结束屏幕
            gameOverScreen.classList.add('hidden');
            gameOver = false;
            isPaused = false;
            pauseBtn.innerHTML = '<i class="fa fa-pause mr-1"></i>暂停';
            
            // 清空爆炸效果
            explosionEffects = [];
            
            // 开始游戏循环
            if (gameLoop) clearInterval(gameLoop);
            gameLoop = setInterval(update, gameSpeed);
        }

        // 生成食物
        function generateFood() {
            const maxPos = (canvas.width / gridSize) - 1;
            
            // 确保食物不会生成在蛇身上
            let newFood;
            do {
                newFood = {
                    x: Math.floor(Math.random() * maxPos),
                    y: Math.floor(Math.random() * maxPos)
                };
            } while (snake.some(segment => segment.x === newFood.x && segment.y === newFood.y));
            
            food = newFood;
        }

        // 更新游戏状态
        function update() {
            if (isPaused || gameOver) return;
            
            // 更新方向
            direction = nextDirection;
            
            // 获取蛇头位置
            const head = { x: snake[0].x, y: snake[0].y };
            
            // 根据方向移动蛇头
            switch (direction) {
                case 'up':
                    head.y -= 1;
                    break;
                case 'down':
                    head.y += 1;
                    break;
                case 'left':
                    head.x -= 1;
                    break;
                case 'right':
                    head.x += 1;
                    break;
            }
            
            // 检查碰撞
            if (
                head.x < 0 || 
                head.x >= canvas.width / gridSize || 
                head.y < 0 || 
                head.y >= canvas.height / gridSize ||
                snake.some(segment => segment.x === head.x && segment.y === head.y)
            ) {
                gameOver = true;
                clearInterval(gameLoop);
                finalScoreElement.textContent = score;
                gameOverScreen.classList.remove('hidden');
                return;
            }
            
            // 将新头部添加到蛇
            snake.unshift(head);
            
            // 检查是否吃到食物
            if (head.x === food.x && head.y === food.y) {
                // 增加分数
                score += 10;
                scoreElement.textContent = score;
                scoreElement.classList.add('score-popup');
                setTimeout(() => scoreElement.classList.remove('score-popup'), 300);
                
                // 生成爆炸效果
                explosionEffects.push({
                    x: food.x * gridSize,
                    y: food.y * gridSize,
                    size: gridSize * 2,
                    opacity: 1
                });
                
                // 加快游戏速度
                if (gameSpeed > 70) {
                    gameSpeed -= 2;
                    clearInterval(gameLoop);
                    gameLoop = setInterval(update, gameSpeed);
                }
                
                // 生成新食物
                generateFood();
            } else {
                // 如果没吃到食物，移除尾部
                snake.pop();
            }
            
            // 更新爆炸效果
            updateExplosions();
            
            // 绘制游戏
            draw();
        }

        // 更新爆炸效果
        function updateExplosions() {
            explosionEffects.forEach((effect, index) => {
                effect.opacity -= 0.1;
                effect.size += 1;
                
                // 移除完全透明的爆炸效果
                if (effect.opacity <= 0) {
                    explosionEffects.splice(index, 1);
                }
            });
        }

        // 绘制游戏
        function draw() {
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制蛇
            snake.forEach((segment, index) => {
                // 根据分数确定颜色
                const colorIndex = Math.floor(score / 50) % snakeColors.length;
                const baseColor = snakeColors[colorIndex];
                
                // 为不同段使用不同的透明度
                const alpha = 0.7 + (index / snake.length) * 0.3;
                
                // 绘制蛇段
                ctx.fillStyle = baseColor;
                ctx.fillRect(
                    segment.x * gridSize, 
                    segment.y * gridSize, 
                    gridSize - 1, 
                    gridSize - 1
                );
                
                // 绘制半调图案覆盖层
                drawHalfTone(
                    segment.x * gridSize, 
                    segment.y * gridSize, 
                    gridSize - 1, 
                    gridSize - 1, 
                    index % halfTonePatterns.length,
                    alpha
                );
            });
            
            // 绘制食物
            if (customFoodImage) {
                ctx.save();
                ctx.globalAlpha = 0.9;
                ctx.drawImage(
                    customFoodImage,
                    food.x * gridSize,
                    food.y * gridSize,
                    gridSize,
                    gridSize
                );
                ctx.restore();
            } else if (foodImage.complete) {
                ctx.save();
                ctx.globalAlpha = 0.9;
                ctx.drawImage(
                    foodImage,
                    food.x * gridSize,
                    food.y * gridSize,
                    gridSize,
                    gridSize
                );
                ctx.restore();
            } else {
                // 如果图片未加载完成，绘制备用图形
                ctx.fillStyle = '#FFCC00';
                ctx.beginPath();
                ctx.arc(
                    food.x * gridSize + gridSize / 2,
                    food.y * gridSize + gridSize / 2,
                    gridSize / 2 - 1,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                
                // 添加半调效果
                drawHalfTone(
                    food.x * gridSize, 
                    food.y * gridSize, 
                    gridSize, 
                    gridSize, 
                    1,
                    0.5
                );
            }
            
            // 绘制爆炸效果
            explosionEffects.forEach(effect => {
                const colors = ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#007AFF'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                ctx.fillStyle = `rgba(${hexToRgb(color)}, ${effect.opacity})`;
                ctx.beginPath();
                ctx.arc(
                    effect.x + gridSize / 2,
                    effect.y + gridSize / 2,
                    effect.size / 2,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
            });
        }

        // 绘制半调图案
        function drawHalfTone(x, y, width, height, patternType, alpha) {
            ctx.save();
            ctx.globalAlpha = alpha;
            
            const patternSize = 4;
            const gap = 2;
            
            for (let i = 0; i < width; i += patternSize + gap) {
                for (let j = 0; j < height; j += patternSize + gap) {
                    // 不同图案类型的位置偏移
                    let offsetX = 0;
                    let offsetY = 0;
                    
                    if (patternType === 1) {
                        offsetX = (patternSize + gap) / 2;
                        offsetY = (patternSize + gap) / 2;
                    } else if (patternType === 2) {
                        offsetX = i % 2 === 0 ? 0 : (patternSize + gap) / 2;
                    }
                    
                    // 绘制点
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.beginPath();
                    ctx.arc(
                        x + i + offsetX,
                        y + j + offsetY,
                        patternSize / 2,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                }
            }
            
            ctx.restore();
        }

        // 十六进制颜色转RGB
        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        // 键盘控制
        function handleKeyDown(e) {
            const key = e.key;
            
            // 空格键控制暂停
            if (key === ' ') {
                togglePause();
                return;
            }
            
            // 方向控制（防止180度转向）
            if (key === 'ArrowUp' && direction !== 'down') {
                nextDirection = 'up';
            } else if (key === 'ArrowDown' && direction !== 'up') {
                nextDirection = 'down';
            } else if (key === 'ArrowLeft' && direction !== 'right') {
                nextDirection = 'left';
            } else if (key === 'ArrowRight' && direction !== 'left') {
                nextDirection = 'right';
            }
        }

        // 触摸控制
        function setupTouchControls() {
            btnUp.addEventListener('click', () => {
                if (direction !== 'down') {
                    nextDirection = 'up';
                }
            });
            
            btnDown.addEventListener('click', () => {
                if (direction !== 'up') {
                    nextDirection = 'down';
                }
            });
            
            btnLeft.addEventListener('click', () => {
                if (direction !== 'right') {
                    nextDirection = 'left';
                }
            });
            
            btnRight.addEventListener('click', () => {
                if (direction !== 'left') {
                    nextDirection = 'right';
                }
            });
        }

        // 切换暂停状态
        function togglePause() {
            if (gameOver) return;
            
            isPaused = !isPaused;
            
            if (isPaused) {
                clearInterval(gameLoop);
                pauseBtn.innerHTML = '<i class="fa fa-play mr-1"></i>继续';
            } else {
                gameLoop = setInterval(update, gameSpeed);
                pauseBtn.innerHTML = '<i class="fa fa-pause mr-1"></i>暂停';
            }
        }

        // 处理食物图片上传
        function handleFoodImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    customFoodImage = img;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 恢复默认食物图片
        function resetFoodImage() {
            customFoodImage = null;
            foodImage.src = 'https://picsum.photos/seed/cherry/20/20';
        }

        // 事件监听
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('keydown', handleKeyDown);
        restartBtn.addEventListener('click', initGame);
        pauseBtn.addEventListener('click', togglePause);
        foodImageUpload.addEventListener('change', handleFoodImageUpload);
        resetFoodBtn.addEventListener('click', resetFoodImage);

        // 初始化
        resizeCanvas();
        setupTouchControls();
        initGame();
    </script>
</body>
</html>
