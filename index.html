<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>编程社团文件收发系统</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- JSZip 用于压缩文件 -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  
  <!-- 统一的 Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#64748b',
            accent: '#22c55e',
            warning: '#f59e0b',
            danger: '#ef4444',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .glass-effect {
        @apply bg-white bg-opacity-20 backdrop-blur-lg;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .transition-all-300 {
        @apply transition-all duration-300 ease-in-out;
      }
    }
  </style>
  <style>
    /* 自定义样式 */
    .drag-area {
      border: 2px dashed #3b82f6;
      transition: all 0.3s ease;
    }
    
    .drag-area.active {
      border-color: #22c55e;
      background-color: rgba(34, 197, 94, 0.1);
    }
    
    .progress-bar {
      height: 4px;
      background-color: #e2e8f0;
      border-radius: 2px;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      background-color: #3b82f6;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .file-item {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .file-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 50;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .modal.active .modal-content {
      transform: scale(1);
      opacity: 1;
    }
    
    /* 骨架屏动画 */
    @keyframes shimmer {
      0% {
        background-position: -468px 0;
      }
      100% {
        background-position: 468px 0;
      }
    }
    
    .skeleton {
      background: linear-gradient(to right, #f6f7f8 8%, #edeef1 18%, #f6f7f8 33%);
      background-size: 800px 104px;
      animation: shimmer 1.5s linear infinite;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-md">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-cloud-upload text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-primary">编程社团文件收发系统</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="admin-toggle" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-sm transition-all-300">
          <i class="fa fa-user-circle mr-1"></i> 管理员模式
        </button>
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 transition-all-300">
          <i class="fa fa-moon-o"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- 主要内容区 -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <!-- 上传区域 -->
    <section class="mb-10">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fa fa-upload text-primary mr-2"></i> 文件上传
        </h2>
        <div id="drag-area" class="drag-area rounded-lg p-8 text-center cursor-pointer">
          <input type="file" id="file-input" class="hidden" multiple />
          <div class="flex flex-col items-center justify-center">
            <i class="fa fa-cloud-upload text-5xl text-primary mb-4"></i>
            <p class="text-gray-600 mb-2">拖拽文件到此处或</p>
            <button id="upload-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 transition-all-300">
              <i class="fa fa-folder-open mr-1"></i> 选择文件
            </button>
            <p class="text-xs text-gray-500 mt-4">支持多文件上传，单个文件不超过2MB</p>
          </div>
        </div>
        
        <!-- 上传进度区域 -->
        <div id="upload-progress" class="mt-6 hidden">
          <div class="flex justify-between items-center mb-1">
            <span id="uploading-file-name" class="text-sm font-medium"></span>
            <span id="upload-percentage" class="text-sm font-medium">0%</span>
          </div>
          <div class="progress-bar">
            <div id="progress-bar-fill" class="progress-bar-fill"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 文件列表区域 -->
    <section id="file-list-section" class="mb-10 hidden">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-4">
          <h2 class="text-xl font-semibold flex items-center">
            <i class="fa fa-file-text-o text-primary mr-2"></i> 文件列表
          </h2>
          <div class="flex flex-col sm:flex-row gap-3">
            <div class="relative">
              <input type="text" id="search-input" placeholder="搜索文件..." class="pl-8 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
              <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            <div class="flex gap-2">
              <button id="download-all-btn" class="px-3 py-2 bg-accent text-white rounded-md hover:bg-green-600 transition-all-300 flex items-center">
                <i class="fa fa-download mr-1"></i> 下载全部
              </button>
              <button id="delete-all-btn" class="px-3 py-2 bg-danger text-white rounded-md hover:bg-red-600 transition-all-300 flex items-center">
                <i class="fa fa-trash mr-1"></i> 删除全部
              </button>
            </div>
          </div>
        </div>
        
        <!-- 文件列表 -->
        <div id="file-list" class="mt-6 divide-y divide-gray-200">
          <!-- 文件项将通过JavaScript动态生成 -->
          <div id="empty-state" class="py-10 text-center hidden">
            <i class="fa fa-folder-open-o text-5xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">暂无文件，请上传文件</p>
          </div>
          
          <!-- 骨架屏 -->
          <div id="skeleton-loader" class="hidden">
            <div class="py-4 flex items-center">
              <div class="w-10 h-10 skeleton rounded-md mr-4"></div>
              <div class="flex-grow">
                <div class="h-4 skeleton rounded w-1/3 mb-2"></div>
                <div class="h-3 skeleton rounded w-1/4"></div>
              </div>
              <div class="w-24 h-8 skeleton rounded"></div>
            </div>
            <div class="py-4 flex items-center">
              <div class="w-10 h-10 skeleton rounded-md mr-4"></div>
              <div class="flex-grow">
                <div class="h-4 skeleton rounded w-1/2 mb-2"></div>
                <div class="h-3 skeleton rounded w-1/3"></div>
              </div>
              <div class="w-24 h-8 skeleton rounded"></div>
            </div>
            <div class="py-4 flex items-center">
              <div class="w-10 h-10 skeleton rounded-md mr-4"></div>
              <div class="flex-grow">
                <div class="h-4 skeleton rounded w-1/4 mb-2"></div>
                <div class="h-3 skeleton rounded w-1/2"></div>
              </div>
              <div class="w-24 h-8 skeleton rounded"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 底部版权信息 -->
  <footer class="bg-white shadow-inner py-4">
    <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
      <p>? 2025 编程社团文件收发系统 | 仅用于社团内部文件共享</p>
    </div>
  </footer>

  <!-- 密码验证模态框 - 用于下载文件 -->
  <div id="download-password-modal" class="modal">
    <div class="modal-content w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">下载文件</h3>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <p class="text-gray-600 mb-4">请输入下载密码以获取文件</p>
      <form class="password-form space-y-4" data-purpose="download">
        <div>
          <input type="password" class="password-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入密码">
        </div>
        <div class="flex justify-end">
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 transition-all-300">
            确认下载
          </button>
        </div>
      </form>
      <p class="password-error text-danger text-sm mt-2 hidden">密码错误，请重试</p>
    </div>
  </div>

  <!-- 管理员密码验证模态框 -->
  <div id="admin-password-modal" class="modal">
    <div class="modal-content w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">管理员验证</h3>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <p class="text-gray-600 mb-4">请输入管理员密码以切换到管理员模式</p>
      <form class="password-form space-y-4" data-purpose="admin">
        <div>
          <input type="password" class="password-input w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入管理员密码">
        </div>
        <div class="flex justify-end">
          <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-600 transition-all-300">
            确认
          </button>
        </div>
      </form>
      <p class="password-error text-danger text-sm mt-2 hidden">密码错误，请重试</p>
    </div>
  </div>

  <!-- 确认删除所有文件模态框 -->
  <div id="confirm-delete-modal" class="modal">
    <div class="modal-content w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">确认删除</h3>
        <button class="close-modal text-gray-400 hover:text-gray-600">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <p class="text-gray-600 mb-4">确定要删除所有文件吗？此操作不可撤销。</p>
      <div class="flex justify-end space-x-3">
        <button class="cancel-delete px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-all-300">
          取消
        </button>
        <button id="confirm-delete-all-btn" class="px-4 py-2 bg-danger text-white rounded-md hover:bg-red-600 transition-all-300">
          确认删除
        </button>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // 全局变量
    const FILE_STORAGE_KEY = 'club_files';
    const ADMIN_MODE_KEY = 'admin_mode';
    const CORRECT_PASSWORD = '20130203';
    let currentFileId = null;
    let adminMode = localStorage.getItem(ADMIN_MODE_KEY) === 'true';

    // DOM元素
    const dragArea = document.getElementById('drag-area');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadProgress = document.getElementById('upload-progress');
    const uploadingFileName = document.getElementById('uploading-file-name');
    const uploadPercentage = document.getElementById('upload-percentage');
    const progressBarFill = document.getElementById('progress-bar-fill');
    const fileListSection = document.getElementById('file-list-section');
    const fileList = document.getElementById('file-list');
    const emptyState = document.getElementById('empty-state');
    const skeletonLoader = document.getElementById('skeleton-loader');
    const searchInput = document.getElementById('search-input');
    const adminToggle = document.getElementById('admin-toggle');
    const themeToggle = document.getElementById('theme-toggle');
    const downloadAllBtn = document.getElementById('download-all-btn');
    const deleteAllBtn = document.getElementById('delete-all-btn');
    const confirmDeleteModal = document.getElementById('confirm-delete-modal');
    const confirmDeleteAllBtn = document.getElementById('confirm-delete-all-btn');
    
    // 模态框相关元素
    const modals = document.querySelectorAll('.modal');
    const closeModalButtons = document.querySelectorAll('.close-modal');
    const passwordForms = document.querySelectorAll('.password-form');
    const cancelDeleteButtons = document.querySelectorAll('.cancel-delete');

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      initDragAndDrop();
      initEventListeners();
      updateAdminModeUI();
      if (adminMode) {
        loadFiles();
      }
    });

    // 初始化拖拽功能
    function initDragAndDrop() {
      // 拖拽进入
      dragArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dragArea.classList.add('active');
      });

      // 拖拽离开
      dragArea.addEventListener('dragleave', () => {
        dragArea.classList.remove('active');
      });

      // 放置文件
      dragArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dragArea.classList.remove('active');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFiles(files);
        }
      });
    }

    // 初始化事件监听器
    function initEventListeners() {
      // 上传按钮点击
      uploadBtn.addEventListener('click', () => {
        fileInput.click();
      });

      // 文件选择
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
          handleFiles(fileInput.files);
        }
      });

      // 搜索输入
      searchInput.addEventListener('input', debounce(() => {
        const searchTerm = searchInput.value.toLowerCase();
        filterFiles(searchTerm);
      }, 300));

      // 关闭模态框
      closeModalButtons.forEach(button => {
        button.addEventListener('click', () => {
          const modal = button.closest('.modal');
          closeModal(modal);
        });
      });

      // 取消删除
      cancelDeleteButtons.forEach(button => {
        button.addEventListener('click', () => {
          const modal = button.closest('.modal');
          closeModal(modal);
        });
      });

      // 密码表单提交
      passwordForms.forEach(form => {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const password = form.querySelector('.password-input').value.trim();
          const purpose = form.dataset.purpose;
          const modal = form.closest('.modal');
          const errorElement = form.querySelector('.password-error');
          
          if (password === CORRECT_PASSWORD) {
            if (purpose === 'download') {
              downloadFile(currentFileId);
            } else if (purpose === 'admin') {
              enterAdminMode();
            }
            closeModal(modal);
          } else {
            errorElement.classList.remove('hidden');
          }
        });
      });

      // 管理员模式切换
      adminToggle.addEventListener('click', () => {
        if (adminMode) {
          exitAdminMode();
        } else {
          // 显示管理员密码模态框
          document.getElementById('admin-password-modal').classList.add('active');
        }
      });

      // 主题切换
      themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        const icon = themeToggle.querySelector('i');
        if (document.body.classList.contains('dark')) {
          icon.classList.remove('fa-moon-o');
          icon.classList.add('fa-sun-o');
        } else {
          icon.classList.remove('fa-sun-o');
          icon.classList.add('fa-moon-o');
        }
      });

      // 下载所有文件
      downloadAllBtn.addEventListener('click', downloadAllFiles);

      // 删除所有文件 - 显示确认框
      deleteAllBtn.addEventListener('click', () => {
        const files = JSON.parse(localStorage.getItem(FILE_STORAGE_KEY) || '[]');
        if (files.length > 0) {
          confirmDeleteModal.classList.add('active');
        } else {
          alert('没有文件可删除');
        }
      });

      // 确认删除所有文件
      confirmDeleteAllBtn.addEventListener('click', () => {
        if (confirm('确定要删除所有文件吗？此操作不可撤销。')) {
          deleteAllFiles();
          closeModal(confirmDeleteModal);
        }
      });
    }

    // 进入管理员模式
    function enterAdminMode() {
      adminMode = true;
      localStorage.setItem(ADMIN_MODE_KEY, adminMode);
      updateAdminModeUI();
      loadFiles();
    }

    // 退出管理员模式
    function exitAdminMode() {
      adminMode = false;
      localStorage.setItem(ADMIN_MODE_KEY, adminMode);
      updateAdminModeUI();
    }

    // 更新管理员模式UI
    function updateAdminModeUI() {
      if (adminMode) {
        adminToggle.innerHTML = '<i class="fa fa-user mr-1"></i> 退出管理员';
        adminToggle.classList.remove('bg-gray-100', 'hover:bg-gray-200');
        adminToggle.classList.add('bg-primary', 'text-white', 'hover:bg-blue-600');
        fileListSection.classList.remove('hidden');
      } else {
        adminToggle.innerHTML = '<i class="fa fa-user-circle mr-1"></i> 管理员模式';
        adminToggle.classList.remove('bg-primary', 'text-white', 'hover:bg-blue-600');
        adminToggle.classList.add('bg-gray-100', 'hover:bg-gray-200');
        fileListSection.classList.add('hidden');
      }
    }

    // 处理文件上传
    function handleFiles(files) {
      // 检查文件大小
      const validFiles = Array.from(files).filter(file => file.size <= 2 * 1024 * 1024); // 2MB
      
      if (validFiles.length === 0) {
        alert('所有文件都超过了2MB的大小限制');
        return;
      }
      
      // 处理每个文件
      validFiles.forEach((file, index) => {
        uploadFile(file, index, validFiles.length);
      });
    }

    // 上传文件
    function uploadFile(file, index, total) {
      const reader = new FileReader();
      
      // 更新进度UI
      uploadingFileName.textContent = `(${index + 1}/${total}) ${file.name}`;
      uploadProgress.classList.remove('hidden');
      
      // 读取文件
      reader.onload = (e) => {
        // 创建文件对象
        const fileObj = {
          id: generateUniqueId(),
          name: file.name,
          size: file.size,
          type: file.type,
          uploadTime: new Date().toISOString(),
          content: e.target.result
        };
        
        // 保存文件
        saveFile(fileObj);
        
        // 更新进度
        updateProgress(100);
        
        // 如果是最后一个文件，隐藏进度条
        if (index === total - 1) {
          setTimeout(() => {
            uploadProgress.classList.add('hidden');
            alert('文件上传成功！');
            
            // 如果是管理员模式，重新加载文件列表
            if (adminMode) {
              loadFiles();
            }
          }, 500);
        }
      };
      
      // 进度更新
      reader.onprogress = (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          updateProgress(percent);
        }
      };
      
      // 读取文件为DataURL
      reader.readAsDataURL(file);
    }

    // 更新进度条
    function updateProgress(percent) {
      progressBarFill.style.width = `${percent}%`;
      uploadPercentage.textContent = `${percent}%`;
    }

    // 保存文件到localStorage
    function saveFile(fileObj) {
      // 获取现有文件
      let files = JSON.parse(localStorage.getItem(FILE_STORAGE_KEY) || '[]');
      
      // 添加新文件
      files.unshift(fileObj); // 添加到开头
      
      // 限制文件数量（最多50个）
      if (files.length > 50) {
        files = files.slice(0, 50);
      }
      
      // 保存回localStorage
      localStorage.setItem(FILE_STORAGE_KEY, JSON.stringify(files));
    }

    // 加载文件列表
    function loadFiles() {
      if (!adminMode) return;
      
      // 显示骨架屏
      skeletonLoader.classList.remove('hidden');
      emptyState.classList.add('hidden');
      fileList.innerHTML = '';
      
      // 模拟加载延迟
      setTimeout(() => {
        // 获取文件
        const files = JSON.parse(localStorage.getItem(FILE_STORAGE_KEY) || '[]');
        
        // 隐藏骨架屏
        skeletonLoader.classList.add('hidden');
        
        // 检查是否有文件
        if (files.length === 0) {
          emptyState.classList.remove('hidden');
          return;
        }
        
        // 显示文件列表
        files.forEach(file => {
          addFileToDOM(file);
        });
      }, 800);
    }

    // 添加文件到DOM
    function addFileToDOM(file) {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item py-4 flex items-center justify-between';
      fileItem.dataset.id = file.id;
      fileItem.dataset.name = file.name.toLowerCase();
      
      // 获取文件图标
      const fileIcon = getFileIcon(file.type);
      
      // 文件大小格式化
      const fileSize = formatFileSize(file.size);
      
      // 上传时间格式化
      const uploadTime = formatDateTime(file.uploadTime);
      
      fileItem.innerHTML = `
        <div class="flex items-center">
          <div class="w-10 h-10 flex items-center justify-center rounded-md bg-gray-100 mr-4">
            <i class="fa ${fileIcon} text-primary"></i>
          </div>
          <div>
            <h4 class="font-medium">${file.name}</h4>
            <p class="text-sm text-gray-500">${fileSize} · ${uploadTime}</p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <button class="download-btn px-3 py-1 bg-primary text-white rounded-md hover:bg-blue-600 transition-all-300">
            <i class="fa fa-download mr-1"></i> 下载
          </button>
          <button class="delete-btn px-2 py-1 bg-gray-100 text-gray-600 rounded-md hover:bg-gray-200 transition-all-300">
            <i class="fa fa-trash"></i>
          </button>
        </div>
      `;
      
      // 添加到DOM
      fileList.appendChild(fileItem);
      
      // 添加事件监听器
      const downloadBtn = fileItem.querySelector('.download-btn');
      const deleteBtn = fileItem.querySelector('.delete-btn');
      
      downloadBtn.addEventListener('click', () => {
        currentFileId = file.id;
        document.getElementById('download-password-modal').classList.add('active');
      });
      
      deleteBtn.addEventListener('click', () => {
        if (confirm('确定要删除这个文件吗？')) {
          deleteFile(file.id);
          fileItem.remove();
          
          // 检查是否还有文件
          if (fileList.children.length === 0) {
            emptyState.classList.remove('hidden');
          }
        }
      });
    }

    // 获取文件图标
    function getFileIcon(fileType) {
      if (fileType.startsWith('image/')) {
        return 'fa-file-image-o';
      } else if (fileType.startsWith('video/')) {
        return 'fa-file-video-o';
      } else if (fileType.startsWith('audio/')) {
        return 'fa-file-audio-o';
      } else if (fileType.includes('pdf')) {
        return 'fa-file-pdf-o';
      } else if (fileType.includes('word') || fileType.includes('document')) {
        return 'fa-file-word-o';
      } else if (fileType.includes('excel') || fileType.includes('spreadsheet')) {
        return 'fa-file-excel-o';
      } else if (fileType.includes('powerpoint') || fileType.includes('presentation')) {
        return 'fa-file-powerpoint-o';
      } else if (fileType.includes('zip') || fileType.includes('compressed')) {
        return 'fa-file-zip-o';
      } else if (fileType.includes('text') || fileType.includes('plain')) {
        return 'fa-file-text-o';
      } else {
        return 'fa-file-o';
      }
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // 格式化日期时间
    function formatDateTime(dateTimeString) {
      const date = new Date(dateTimeString);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // 关闭模态框
    function closeModal(modal) {
      if (modal) {
        modal.classList.remove('active');
        // 重置表单
        const form = modal.querySelector('form');
        if (form) {
          form.reset();
          const errorElement = form.querySelector('.password-error');
          if (errorElement) {
            errorElement.classList.add('hidden');
          }
        }
      }
    }

    // 下载文件
    function downloadFile(fileId) {
      // 获取文件
      const files = JSON.parse(localStorage.getItem(FILE_STORAGE_KEY) || '[]');
      const file = files.find(f => f.id === fileId);
      
      if (!file) {
        alert('文件不存在或已被删除');
        return;
      }
      
      // 创建下载链接
      const link = document.createElement('a');
      link.href = file.content;
      link.download = file.name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // 下载所有文件为ZIP压缩包
    function downloadAllFiles() {
      const files = JSON.parse(localStorage.getItem(FILE_STORAGE_KEY) || '[]');
      
      if (files.length === 0) {
        alert('没有文件可下载');
        return;
      }
      
      // 创建ZIP文件
      const zip = new JSZip();
      
      // 添加文件到ZIP
      files.forEach(file => {
        // 从DataURL中提取二进制数据
        const base64Data = file.content.split(',')[1];
        const binaryData = atob(base64Data);
        
        // 添加到ZIP
        zip.file(file.name, binaryData, { binary: true });
      });
      
      // 生成ZIP文件并下载
      zip.generateAsync({ type: 'blob' }, (metadata) => {
        // 可以添加进度指示
        console.log(`生成中: ${metadata.percent.toFixed(2)}%`);
      }).then((content) => {
        // 创建下载链接
        const link = document.createElement('a');
        const date = new Date();
        const dateString = date.toISOString().slice(0, 10);
        link.download = `社团文件_${dateString}.zip`;
        link.href = URL.createObjectURL(content);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }).catch((err) => {
        console.error('ZIP生成失败:', err);
        alert('文件打包失败，请重试');
      });
    }

    // 删除文件
    function deleteFile(fileId) {
      // 获取文件
      let files = JSON.parse(localStorage.getItem(FILE_STORAGE_KEY) || '[]');
      
      // 过滤掉要删除的文件
      files = files.filter(file => file.id !== fileId);
      
      // 保存回localStorage
      localStorage.setItem(FILE_STORAGE_KEY, JSON.stringify(files));
    }

    // 删除所有文件
    function deleteAllFiles() {
      localStorage.removeItem(FILE_STORAGE_KEY);
      fileList.innerHTML = '';
      emptyState.classList.remove('hidden');
      alert('所有文件已删除');
    }

    // 过滤文件
    function filterFiles(searchTerm) {
      const fileItems = fileList.querySelectorAll('.file-item');
      
      fileItems.forEach(item => {
        const fileName = item.dataset.name;
        
        if (fileName.includes(searchTerm)) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });
      
      // 检查是否有可见文件
      const visibleFiles = Array.from(fileItems).filter(item => !item.classList.contains('hidden'));
      
      if (visibleFiles.length === 0) {
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
      }
    }

    // 生成唯一ID
    function generateUniqueId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }

    // 防抖函数
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }
  </script>
</body>
</html>
