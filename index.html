<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>七（3）班积分系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #4F46E5;
            --secondary-color: #EC4899;
            --background-color: #F3F4F6;
            --card-background: #FFFFFF;
            --text-color: #1F2937;
            --muted-text-color: #6B7280;
        }
        .dark {
            --primary-color: #6366F1;
            --secondary-color: #F472B6;
            --background-color: #111827;
            --card-background: #1F2937;
            --text-color: #F9FAFB;
            --muted-text-color: #9CA3AF;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            background-color: var(--card-background);
        }
        .main-content {
            background-color: var(--background-color);
        }
        .card {
            background-color: var(--card-background);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #4338CA;
        }
        .dark .btn-primary:hover {
            background-color: #4F46E5;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background-color: #1F2937;
            color: #F9FAFB;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 9999;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="flex h-screen">

    <!-- Sidebar -->
    <aside class="sidebar w-64 flex-shrink-0 p-4 space-y-6">
        <div class="flex items-center space-x-2">
            <i data-lucide="award" class="text-primary-color"></i>
            <h1 class="text-2xl font-bold">积分系统</h1>
        </div>
        <nav class="space-y-2">
            <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-page="dashboard">
                <i data-lucide="layout-dashboard"></i>
                <span>仪表盘</span>
            </a>
            <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-page="students">
                <i data-lucide="users"></i>
                <span>学生列表</span>
            </a>
            <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-page="scores">
                <i data-lucide="file-plus-2"></i>
                <span>积分操作</span>
            </a>
            <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-page="statistics">
                <i data-lucide="bar-chart-3"></i>
                <span>积分统计</span>
            </a>
            <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-page="settings">
                <i data-lucide="settings"></i>
                <span>系统设置</span>
            </a>
        </nav>
        <div class="absolute bottom-4">
            <button id="theme-toggle" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                <i data-lucide="sun" class="sun-icon"></i>
                <i data-lucide="moon" class="moon-icon hidden"></i>
                <span>切换主题</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="main-content flex-1 p-6 overflow-y-auto">
        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page">
            <h2 class="text-3xl font-bold mb-6">仪表盘</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-muted-text-color">学生总数</p>
                            <p id="total-students" class="text-3xl font-bold">0</p>
                        </div>
                        <i data-lucide="users" class="text-primary-color"></i>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-muted-text-color">总积分</p>
                            <p id="total-scores" class="text-3xl font-bold">0</p>
                        </div>
                        <i data-lucide="award" class="text-primary-color"></i>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-muted-text-color">本月积分变动</p>
                            <p id="monthly-change" class="text-3xl font-bold">+0</p>
                        </div>
                        <i data-lucide="trending-up" class="text-secondary-color"></i>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-muted-text-color">积分类型</p>
                            <p id="score-types" class="text-3xl font-bold">0</p>
                        </div>
                        <i data-lucide="tags" class="text-secondary-color"></i>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <div class="lg:col-span-2 card p-6">
                    <h3 class="text-xl font-bold mb-4">积分排行榜</h3>
                    <canvas id="top-students-chart"></canvas>
                </div>
                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">积分类型分布</h3>
                    <canvas id="score-type-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Students Page -->
        <div id="students-page" class="page hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">学生列表</h2>
                <button id="add-student-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center space-x-2">
                    <i data-lucide="plus"></i>
                    <span>添加学生</span>
                </button>
            </div>
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="student-search" placeholder="搜索学生..." class="border rounded-lg px-4 py-2 bg-transparent">
                        <button id="search-btn" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                            <i data-lucide="search"></i>
                        </button>
                    </div>
                    <select id="student-sort" class="border rounded-lg px-4 py-2 bg-transparent">
                        <option value="name-asc">姓名 (A-Z)</option>
                        <option value="name-desc">姓名 (Z-A)</option>
                        <option value="score-asc">积分从低到高</option>
                        <option value="score-desc">积分从高到低</option>
                    </select>
                </div>
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b dark:border-gray-700">
                            <th class="p-2">学号</th>
                            <th class="p-2">姓名</th>
                            <th class="p-2">总积分</th>
                            <th class="p-2">操作</th>
                        </tr>
                    </thead>
                    <tbody id="students-table-body">
                        <!-- Student rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Scores Page -->
        <div id="scores-page" class="page hidden">
            <h2 class="text-3xl font-bold mb-6">积分操作</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 card p-6">
                    <h3 class="text-xl font-bold mb-4">积分记录</h3>
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="score-search" placeholder="搜索记录..." class="border rounded-lg px-4 py-2 bg-transparent">
                            <button id="score-search-btn" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                                <i data-lucide="search"></i>
                            </button>
                        </div>
                        <select id="score-filter" class="border rounded-lg px-4 py-2 bg-transparent">
                            <option value="all">所有类型</option>
                            <!-- Score types will be inserted here -->
                        </select>
                    </div>
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b dark:border-gray-700">
                                <th class="p-2">学生</th>
                                <th class="p-2">类型</th>
                                <th class="p-2">积分</th>
                                <th class="p-2">时间</th>
                                <th class="p-2">备注</th>
                                <th class="p-2">操作</th>
                            </tr>
                        </thead>
                        <tbody id="scores-table-body">
                            <!-- Score rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">添加积分</h3>
                    <form id="add-score-form" class="space-y-4">
                        <div>
                            <label for="score-student" class="block mb-2">学生</label>
                            <select id="score-student" class="w-full border rounded-lg px-4 py-2 bg-transparent" required>
                                <!-- Students will be inserted here -->
                            </select>
                        </div>
                        <div>
                            <label for="score-type" class="block mb-2">积分类型</label>
                            <select id="score-type" class="w-full border rounded-lg px-4 py-2 bg-transparent" required>
                                <!-- Score types will be inserted here -->
                            </select>
                        </div>
                        <div>
                            <label for="score-value" class="block mb-2">积分值</label>
                            <input type="number" id="score-value" class="w-full border rounded-lg px-4 py-2 bg-transparent" required>
                        </div>
                        <div>
                            <label for="score-note" class="block mb-2">备注</label>
                            <textarea id="score-note" rows="3" class="w-full border rounded-lg px-4 py-2 bg-transparent"></textarea>
                        </div>
                        <button type="submit" class="btn-primary w-full px-4 py-2 rounded-lg">添加</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Statistics Page -->
        <div id="statistics-page" class="page hidden">
            <h2 class="text-3xl font-bold mb-6">积分统计</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">学生积分排行</h3>
                    <canvas id="student-ranking-chart"></canvas>
                </div>
                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">积分类型占比</h3>
                    <canvas id="score-distribution-chart"></canvas>
                </div>
                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">月度积分趋势</h3>
                    <canvas id="monthly-trend-chart"></canvas>
                </div>
                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">积分明细</h3>
                    <div id="statistics-detail" class="space-y-4">
                        <!-- Detail will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings-page" class="page hidden">
            <h2 class="text-3xl font-bold mb-6">系统设置</h2>
            <div class="card p-6">
                <h3 class="text-xl font-bold mb-4">积分类型管理</h3>
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="new-score-type-name" placeholder="积分类型名称" class="border rounded-lg px-4 py-2 bg-transparent">
                        <input type="number" id="new-score-type-value" placeholder="积分值" class="border rounded-lg px-4 py-2 bg-transparent" style="width: 120px;">
                    </div>
                    <button id="add-score-type-btn" class="btn-primary px-4 py-2 rounded-lg">添加</button>
                </div>
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b dark:border-gray-700">
                            <th class="p-2">类型</th>
                            <th class="p-2">积分值</th>
                            <th class="p-2">操作</th>
                        </tr>
                    </thead>
                    <tbody id="score-types-table-body">
                        <!-- Score type rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="card p-6 mt-6">
                <h3 class="text-xl font-bold mb-4">数据管理</h3>
                <div class="flex space-x-4">
                    <button id="export-data-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center space-x-2">
                        <i data-lucide="download"></i>
                        <span>导出数据</span>
                    </button>
                    <button id="import-data-btn" class="btn-primary px-4 py-2 rounded-lg flex items-center space-x-2">
                        <i data-lucide="upload"></i>
                        <span>导入数据</span>
                    </button>
                    <input type="file" id="import-data-input" accept=".json" class="hidden">
                    <button id="clear-data-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                        <i data-lucide="trash-2"></i>
                        <span>清空数据</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="add-student-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="card p-8 rounded-lg w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4">添加学生</h3>
            <form id="add-student-form" class="space-y-4">
                <div>
                    <label for="student-name" class="block mb-2">姓名</label>
                    <input type="text" id="student-name" class="w-full border rounded-lg px-4 py-2 bg-transparent" required>
                </div>
                <div>
                    <label for="student-id" class="block mb-2">学号</label>
                    <input type="text" id="student-id" class="w-full border rounded-lg px-4 py-2 bg-transparent" required>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-add-student" class="px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">取消</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded-lg">添加</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-score-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="card p-8 rounded-lg w-full max-w-md">
            <h3 class="text-2xl font-bold mb-4">编辑积分记录</h3>
            <form id="edit-score-form" class="space-y-4">
                <input type="hidden" id="edit-score-id">
                <div>
                    <label for="edit-score-student" class="block mb-2">学生</label>
                    <select id="edit-score-student" class="w-full border rounded-lg px-4 py-2 bg-transparent" required>
                        <!-- Students will be inserted here -->
                    </select>
                </div>
                <div>
                    <label for="edit-score-type" class="block mb-2">积分类型</label>
                    <select id="edit-score-type" class="w-full border rounded-lg px-4 py-2 bg-transparent" required>
                        <!-- Score types will be inserted here -->
                    </select>
                </div>
                <div>
                    <label for="edit-score-value" class="block mb-2">积分值</label>
                    <input type="number" id="edit-score-value" class="w-full border rounded-lg px-4 py-2 bg-transparent" required>
                </div>
                <div>
                    <label for="edit-score-note" class="block mb-2">备注</label>
                    <textarea id="edit-score-note" rows="3" class="w-full border rounded-lg px-4 py-2 bg-transparent"></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-edit-score" class="px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">取消</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded-lg">保存</button>
                </div>
            </form>
        </div>
    </div>


    <div id="toast" class="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // --- Data Management ---
            let students = JSON.parse(localStorage.getItem('students')) || [];
            let scoreRecords = JSON.parse(localStorage.getItem('scoreRecords')) || [];
            let scoreTypes = JSON.parse(localStorage.getItem('scoreTypes')) || [
                { id: 1, name: '课堂表现', value: 2 },
                { id: 2, name: '作业完成', value: 1 },
                { id: 3, name: '纪律遵守', value: 1 },
                { id: 4, name: '迟到', value: -1 },
                { id: 5, name: '作业未完成', value: -2 },
            ];

            const saveData = () => {
                localStorage.setItem('students', JSON.stringify(students));
                localStorage.setItem('scoreRecords', JSON.stringify(scoreRecords));
                localStorage.setItem('scoreTypes', JSON.stringify(scoreTypes));
                updateUI();
            };

            // --- UI Updates ---
            const updateUI = () => {
                updateDashboard();
                updateStudentsTable();
                updateScoresTable();
                updateScoreTypeOptions();
                updateStatistics();
                updateScoreTypesTable();
            };

            const showToast = (message) => {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            };

            // --- Dashboard ---
            const updateDashboard = () => {
                document.getElementById('total-students').textContent = students.length;
                const totalScores = students.reduce((sum, student) => sum + getStudentTotalScore(student.id), 0);
                document.getElementById('total-scores').textContent = totalScores;
                
                const today = new Date();
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthlyRecords = scoreRecords.filter(record => new Date(record.timestamp) >= startOfMonth);
                const monthlyChange = monthlyRecords.reduce((sum, record) => sum + record.value, 0);
                document.getElementById('monthly-change').textContent = (monthlyChange >= 0 ? '+' : '') + monthlyChange;
                
                document.getElementById('score-types').textContent = scoreTypes.length;

                updateTopStudentsChart();
                updateScoreTypeChart();
            };

            const updateTopStudentsChart = () => {
                const topStudents = [...students]
                    .sort((a, b) => getStudentTotalScore(b.id) - getStudentTotalScore(a.id))
                    .slice(0, 5);

                const ctx = document.getElementById('top-students-chart').getContext('2d');
                if (window.topStudentsChart) {
                    window.topStudentsChart.destroy();
                }
                window.topStudentsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topStudents.map(s => s.name),
                        datasets: [{
                            label: '积分',
                            data: topStudents.map(s => getStudentTotalScore(s.id)),
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            };

            const updateScoreTypeChart = () => {
                const typeCounts = {};
                scoreTypes.forEach(type => typeCounts[type.name] = 0);
                scoreRecords.forEach(record => {
                    const type = scoreTypes.find(t => t.id === record.typeId);
                    if (type) {
                        typeCounts[type.name]++;
                    }
                });

                const ctx = document.getElementById('score-type-chart').getContext('2d');
                if (window.scoreTypeChart) {
                    window.scoreTypeChart.destroy();
                }
                window.scoreTypeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(typeCounts),
                        datasets: [{
                            data: Object.values(typeCounts),
                            backgroundColor: [
                                '#4F46E5', '#EC4899', '#10B981', '#F59E0B', '#EF4444',
                                '#8B5CF6', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
                            ],
                        }]
                    },
                    options: { responsive: true }
                });
            };

            // --- Students ---
            const updateStudentsTable = () => {
                const tbody = document.getElementById('students-table-body');
                tbody.innerHTML = '';
                students.forEach(student => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b dark:border-gray-700';
                    tr.innerHTML = `
                        <td class="p-2">${student.id}</td>
                        <td class="p-2">${student.name}</td>
                        <td class="p-2">${getStudentTotalScore(student.id)}</td>
                        <td class="p-2">
                            <button class="edit-student-btn p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${student.id}">
                                <i data-lucide="edit"></i>
                            </button>
                            <button class="delete-student-btn p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${student.id}">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            };

            const getStudentTotalScore = (studentId) => {
                return scoreRecords
                    .filter(record => record.studentId === studentId)
                    .reduce((sum, record) => sum + record.value, 0);
            };

            // --- Scores ---
            const updateScoresTable = () => {
                const tbody = document.getElementById('scores-table-body');
                tbody.innerHTML = '';
                scoreRecords.slice().reverse().forEach(record => {
                    const student = students.find(s => s.id === record.studentId);
                    const type = scoreTypes.find(t => t.id === record.typeId);
                    if (!student || !type) return;

                    const tr = document.createElement('tr');
                    tr.className = 'border-b dark:border-gray-700';
                    tr.innerHTML = `
                        <td class="p-2">${student.name}</td>
                        <td class="p-2">${type.name}</td>
                        <td class="p-2 ${record.value > 0 ? 'text-green-500' : 'text-red-500'}">${record.value > 0 ? '+' : ''}${record.value}</td>
                        <td class="p-2">${new Date(record.timestamp).toLocaleString()}</td>
                        <td class="p-2">${record.note || '-'}</td>
                        <td class="p-2">
                            <button class="edit-score-btn p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${record.id}">
                                <i data-lucide="edit"></i>
                            </button>
                            <button class="delete-score-btn p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${record.id}">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            };

            const updateScoreTypeOptions = () => {
                const scoreTypeSelects = [
                    document.getElementById('score-type'),
                    document.getElementById('score-filter'),
                    document.getElementById('edit-score-type')
                ];
                scoreTypeSelects.forEach(select => {
                    if (!select) return;
                    const currentValue = select.value;
                    select.innerHTML = '';
                    scoreTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.id;
                        option.textContent = `${type.name} (${type.value > 0 ? '+' : ''}${type.value})`;
                        select.appendChild(option);
                    });
                    select.value = currentValue;
                });

                const scoreStudentSelects = [
                    document.getElementById('score-student'),
                    document.getElementById('edit-score-student')
                ];
                scoreStudentSelects.forEach(select => {
                    if (!select) return;
                    const currentValue = select.value;
                    select.innerHTML = '';
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = student.name;
                        select.appendChild(option);
                    });
                    select.value = currentValue;
                });
            };

            // --- Statistics ---
            const updateStatistics = () => {
                updateStudentRankingChart();
                updateScoreDistributionChart();
                updateMonthlyTrendChart();
                updateStatisticsDetail();
            };

            const updateStudentRankingChart = () => {
                const sortedStudents = [...students].sort((a, b) => getStudentTotalScore(b.id) - getStudentTotalScore(a.id));

                const ctx = document.getElementById('student-ranking-chart').getContext('2d');
                if (window.studentRankingChart) {
                    window.studentRankingChart.destroy();
                }
                window.studentRankingChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedStudents.map(s => s.name),
                        datasets: [{
                            label: '总积分',
                            data: sortedStudents.map(s => getStudentTotalScore(s.id)),
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                        },
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            };

            const updateScoreDistributionChart = () => {
                const typeScores = {};
                scoreTypes.forEach(type => typeScores[type.id] = { name: type.name, total: 0 });
                scoreRecords.forEach(record => {
                    if (typeScores[record.typeId]) {
                        typeScores[record.typeId].total += record.value;
                    }
                });

                const ctx = document.getElementById('score-distribution-chart').getContext('2d');
                if (window.scoreDistributionChart) {
                    window.scoreDistributionChart.destroy();
                }
                window.scoreDistributionChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.values(typeScores).map(t => t.name),
                        datasets: [{
                            data: Object.values(typeScores).map(t => Math.abs(t.total)),
                            backgroundColor: [
                                '#4F46E5', '#EC4899', '#10B981', '#F59E0B', '#EF4444',
                                '#8B5CF6', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
                            ],
                        }]
                    },
                    options: { responsive: true }
                });
            };

            const updateMonthlyTrendChart = () => {
                const monthlyData = {};
                for (let i = 0; i < 12; i++) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    const key = `${date.getFullYear()}-${date.getMonth() + 1}`;
                    monthlyData[key] = 0;
                }

                scoreRecords.forEach(record => {
                    const date = new Date(record.timestamp);
                    const key = `${date.getFullYear()}-${date.getMonth() + 1}`;
                    if (monthlyData[key] !== undefined) {
                        monthlyData[key] += record.value;
                    }
                });

                const labels = Object.keys(monthlyData).reverse();
                const data = Object.values(monthlyData).reverse();

                const ctx = document.getElementById('monthly-trend-chart').getContext('2d');
                if (window.monthlyTrendChart) {
                    window.monthlyTrendChart.destroy();
                }
                window.monthlyTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '月度积分',
                            data: data,
                            borderColor: '#4F46E5',
                            tension: 0.1,
                            fill: true,
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        }]
                    },
                    options: { responsive: true }
                });
            };

            const updateStatisticsDetail = () => {
                const detailContainer = document.getElementById('statistics-detail');
                detailContainer.innerHTML = '';

                const bestStudent = students.reduce((best, current) => {
                    const currentScore = getStudentTotalScore(current.id);
                    const bestScore = getStudentTotalScore(best.id);
                    return currentScore > bestScore ? current : best;
                }, students[0] || { id: 0, name: '无' });

                const worstStudent = students.reduce((worst, current) => {
                    const currentScore = getStudentTotalScore(current.id);
                    const worstScore = getStudentTotalScore(worst.id);
                    return currentScore < worstScore ? current : worst;
                }, students[0] || { id: 0, name: '无' });

                const mostCommonType = scoreTypes.reduce((most, type) => {
                    const typeCount = scoreRecords.filter(r => r.typeId === type.id).length;
                    const mostCount = scoreRecords.filter(r => r.typeId === most.id).length;
                    return typeCount > mostCount ? type : most;
                }, scoreTypes[0] || { id: 0, name: '无' });

                const stats = [
                    { label: '积分最高的学生', value: `${bestStudent.name} (${getStudentTotalScore(bestStudent.id)}分)` },
                    { label: '积分最低的学生', value: `${worstStudent.name} (${getStudentTotalScore(worstStudent.id)}分)` },
                    { label: '最常见的积分类型', value: mostCommonType.name },
                    { label: '本月新增积分记录', value: scoreRecords.filter(r => new Date(r.timestamp) >= new Date(new Date().getFullYear(), new Date().getMonth(), 1)).length },
                ];

                stats.forEach(stat => {
                    const statElement = document.createElement('div');
                    statElement.className = 'flex justify-between items-center p-4 bg-gray-100 dark:bg-gray-700 rounded-lg';
                    statElement.innerHTML = `<span class="font-semibold">${stat.label}:</span> <span>${stat.value}</span>`;
                    detailContainer.appendChild(statElement);
                });
            };

            // --- Settings ---
            const updateScoreTypesTable = () => {
                const tbody = document.getElementById('score-types-table-body');
                tbody.innerHTML = '';
                scoreTypes.forEach(type => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b dark:border-gray-700';
                    tr.innerHTML = `
                        <td class="p-2">${type.name}</td>
                        <td class="p-2 ${type.value > 0 ? 'text-green-500' : 'text-red-500'}">${type.value > 0 ? '+' : ''}${type.value}</td>
                        <td class="p-2">
                            <button class="delete-score-type-btn p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${type.id}">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            };

            // --- Event Listeners ---
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.dataset.page + '-page';
                    document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
                    document.getElementById(pageId).classList.remove('hidden');
                });
            });

            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                document.querySelector('.sun-icon').classList.toggle('hidden', isDark);
                document.querySelector('.moon-icon').classList.toggle('hidden', !isDark);
                updateUI(); // Re-render charts for dark mode
            });

            // Add Student Modal
            document.getElementById('add-student-btn').addEventListener('click', () => {
                document.getElementById('add-student-modal').classList.remove('hidden');
            });

            document.getElementById('cancel-add-student').addEventListener('click', () => {
                document.getElementById('add-student-modal').classList.add('hidden');
                document.getElementById('add-student-form').reset();
            });

            document.getElementById('add-student-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('student-name').value;
                const id = document.getElementById('student-id').value;
                if (students.some(s => s.id === id)) {
                    showToast('学号已存在！');
                    return;
                }
                students.push({ id, name });
                saveData();
                document.getElementById('add-student-modal').classList.add('hidden');
                document.getElementById('add-student-form').reset();
                showToast('学生添加成功！');
            });

            // Edit/Delete Student
            document.getElementById('students-table-body').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const studentId = target.dataset.id;
                if (target.classList.contains('edit-student-btn')) {
                    const student = students.find(s => s.id === studentId);
                    if (student) {
                        document.getElementById('student-name').value = student.name;
                        document.getElementById('student-id').value = student.id;
                        document.getElementById('add-student-modal').classList.remove('hidden');
                        // Logic to handle edit (e.g., a hidden input to track edit mode)
                    }
                } else if (target.classList.contains('delete-student-btn')) {
                    if (confirm('确定要删除该学生吗？相关的积分记录也将被删除。')) {
                        students = students.filter(s => s.id !== studentId);
                        scoreRecords = scoreRecords.filter(r => r.studentId !== studentId);
                        saveData();
                        showToast('学生删除成功！');
                    }
                }
            });

            // Add Score Record
            document.getElementById('add-score-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const studentId = document.getElementById('score-student').value;
                const typeId = parseInt(document.getElementById('score-type').value);
                const type = scoreTypes.find(t => t.id === typeId);
                const value = parseInt(document.getElementById('score-value').value);
                const note = document.getElementById('score-note').value;

                scoreRecords.push({
                    id: Date.now().toString(),
                    studentId,
                    typeId,
                    value,
                    note,
                    timestamp: new Date().toISOString()
                });
                saveData();
                document.getElementById('add-score-form').reset();
                showToast('积分记录添加成功！');
            });
            
            // Edit Score Record Modal
            const openEditScoreModal = (recordId) => {
                const record = scoreRecords.find(r => r.id === recordId);
                if (!record) return;

                document.getElementById('edit-score-id').value = record.id;
                document.getElementById('edit-score-student').value = record.studentId;
                document.getElementById('edit-score-type').value = record.typeId;
                document.getElementById('edit-score-value').value = record.value;
                document.getElementById('edit-score-note').value = record.note || '';
                document.getElementById('edit-score-modal').classList.remove('hidden');
            };

            document.getElementById('cancel-edit-score').addEventListener('click', () => {
                document.getElementById('edit-score-modal').classList.add('hidden');
            });

            document.getElementById('edit-score-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const recordId = document.getElementById('edit-score-id').value;
                const recordIndex = scoreRecords.findIndex(r => r.id === recordId);
                if (recordIndex === -1) return;

                scoreRecords[recordIndex] = {
                    ...scoreRecords[recordIndex],
                    studentId: document.getElementById('edit-score-student').value,
                    typeId: parseInt(document.getElementById('edit-score-type').value),
                    value: parseInt(document.getElementById('edit-score-value').value),
                    note: document.getElementById('edit-score-note').value,
                };
                saveData();
                document.getElementById('edit-score-modal').classList.add('hidden');
                showToast('积分记录更新成功！');
            });


            // Edit/Delete Score Record
            document.getElementById('scores-table-body').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const recordId = target.dataset.id;
                if (target.classList.contains('edit-score-btn')) {
                    openEditScoreModal(recordId);
                } else if (target.classList.contains('delete-score-btn')) {
                    if (confirm('确定要删除这条积分记录吗？')) {
                        scoreRecords = scoreRecords.filter(r => r.id !== recordId);
                        saveData();
                        showToast('积分记录删除成功！');
                    }
                }
            });

            // Add Score Type
            document.getElementById('add-score-type-btn').addEventListener('click', () => {
                const name = document.getElementById('new-score-type-name').value;
                const value = parseInt(document.getElementById('new-score-type-value').value);
                if (!name || value === null) {
                    showToast('请输入完整信息！');
                    return;
                }
                scoreTypes.push({
                    id: Date.now(),
                    name,
                    value
                });
                saveData();
                document.getElementById('new-score-type-name').value = '';
                document.getElementById('new-score-type-value').value = '';
                showToast('积分类型添加成功！');
            });

            // Delete Score Type
            document.getElementById('score-types-table-body').addEventListener('click', (e) => {
                const target = e.target.closest('.delete-score-type-btn');
                if (target) {
                    const typeId = parseInt(target.dataset.id);
                    if (confirm('确定要删除该积分类型吗？')) {
                        scoreTypes = scoreTypes.filter(t => t.id !== typeId);
                        saveData();
                        showToast('积分类型删除成功！');
                    }
                }
            });

            // Search and Sort
            document.getElementById('student-search').addEventListener('input', () => {
                const searchTerm = document.getElementById('student-search').value.toLowerCase();
                const filteredStudents = students.filter(s => s.name.toLowerCase().includes(searchTerm));
                // Re-render the table with filtered students
                const tbody = document.getElementById('students-table-body');
                tbody.innerHTML = '';
                filteredStudents.forEach(student => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b dark:border-gray-700';
                    tr.innerHTML = `
                        <td class="p-2">${student.id}</td>
                        <td class="p-2">${student.name}</td>
                        <td class="p-2">${getStudentTotalScore(student.id)}</td>
                        <td class="p-2">
                            <button class="edit-student-btn p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${student.id}">
                                <i data-lucide="edit"></i>
                            </button>
                            <button class="delete-student-btn p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${student.id}">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            });

            document.getElementById('student-sort').addEventListener('change', () => {
                const sortBy = document.getElementById('student-sort').value;
                switch (sortBy) {
                    case 'name-asc':
                        students.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'name-desc':
                        students.sort((a, b) => b.name.localeCompare(a.name));
                        break;
                    case 'score-asc':
                        students.sort((a, b) => getStudentTotalScore(a.id) - getStudentTotalScore(b.id));
                        break;
                    case 'score-desc':
                        students.sort((a, b) => getStudentTotalScore(b.id) - getStudentTotalScore(a.id));
                        break;
                }
                updateStudentsTable();
            });
            
            // Score Record Search and Filter
            document.getElementById('score-search').addEventListener('input', () => {
                filterAndSearchScores();
            });

            document.getElementById('score-filter').addEventListener('change', () => {
                filterAndSearchScores();
            });

            const filterAndSearchScores = () => {
                const searchTerm = document.getElementById('score-search').value.toLowerCase();
                const filterType = document.getElementById('score-filter').value;

                let filteredRecords = [...scoreRecords];

                if (filterType !== 'all') {
                    filteredRecords = filteredRecords.filter(r => r.typeId.toString() === filterType);
                }

                if (searchTerm) {
                    filteredRecords = filteredRecords.filter(r => {
                        const student = students.find(s => s.id === r.studentId);
                        const type = scoreTypes.find(t => t.id === r.typeId);
                        return (student && student.name.toLowerCase().includes(searchTerm)) ||
                               (type && type.name.toLowerCase().includes(searchTerm)) ||
                               (r.note && r.note.toLowerCase().includes(searchTerm));
                    });
                }

                const tbody = document.getElementById('scores-table-body');
                tbody.innerHTML = '';
                filteredRecords.slice().reverse().forEach(record => {
                    const student = students.find(s => s.id === record.studentId);
                    const type = scoreTypes.find(t => t.id === record.typeId);
                    if (!student || !type) return;

                    const tr = document.createElement('tr');
                    tr.className = 'border-b dark:border-gray-700';
                    tr.innerHTML = `
                        <td class="p-2">${student.name}</td>
                        <td class="p-2">${type.name}</td>
                        <td class="p-2 ${record.value > 0 ? 'text-green-500' : 'text-red-500'}">${record.value > 0 ? '+' : ''}${record.value}</td>
                        <td class="p-2">${new Date(record.timestamp).toLocaleString()}</td>
                        <td class="p-2">${record.note || '-'}</td>
                        <td class="p-2">
                            <button class="edit-score-btn p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${record.id}">
                                <i data-lucide="edit"></i>
                            </button>
                            <button class="delete-score-btn p-1 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${record.id}">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            };


            // Data Import/Export
            document.getElementById('export-data-btn').addEventListener('click', () => {
                const data = { students, scoreRecords, scoreTypes };
                const dataStr = JSON.stringify(data);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `class-score-data-${new Date().toISOString().split('T')[0]}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                showToast('数据导出成功！');
            });

            document.getElementById('import-data-btn').addEventListener('click', () => {
                document.getElementById('import-data-input').click();
            });

            document.getElementById('import-data-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.students && data.scoreRecords && data.scoreTypes) {
                            if (confirm('导入数据将覆盖现有数据，确定继续吗？')) {
                                students = data.students;
                                scoreRecords = data.scoreRecords;
                                scoreTypes = data.scoreTypes;
                                saveData();
                                showToast('数据导入成功！');
                            }
                        } else {
                            showToast('无效的数据文件！');
                        }
                    } catch (err) {
                        showToast('文件解析失败！');
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset input to allow re-importing the same file
            });

            document.getElementById('clear-data-btn').addEventListener('click', () => {
                if (confirm('确定要清空所有数据吗？此操作不可恢复！')) {
                    students = [];
                    scoreRecords = [];
                    scoreTypes = [
                        { id: 1, name: '课堂表现', value: 2 },
                        { id: 2, name: '作业完成', value: 1 },
                        { id: 3, name: '纪律遵守', value: 1 },
                        { id: 4, name: '迟到', value: -1 },
                        { id: 5, name: '作业未完成', value: -2 },
                    ];
                    saveData();
                    showToast('数据已清空！');
                }
            });

            // Initial UI Update
            updateUI();
            // Set active page
            document.querySelector('[data-page="dashboard"]').click();
        });
    </script>
</body>
</html>
